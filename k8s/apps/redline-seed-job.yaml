#
# Copyright (c) 2025 Metaform Systems, Inc.
#
# This program and the accompanying materials are made available under the
# terms of the Apache License, Version 2.0 which is available at
# https://www.apache.org/licenses/LICENSE-2.0
#
# SPDX-License-Identifier: Apache-2.0
#
# Contributors:
#      Metaform Systems, Inc. - initial API and implementation
#

apiVersion: batch/v1
kind: Job
metadata:
  name: redline-seed
  namespace: edc-v
  labels:
    app: redline-seed
    platform: edcv
    type: edcv-job
spec:
  backoffLimit: 5
  template:
    metadata:
      labels:
        app: redline-seed
        platform: edcv
        type: edcv-job
    spec:
      restartPolicy: OnFailure
      initContainers:
        # Wait for tenant-manager to be ready
        - name: wait-for-redline
          image: curlimages/curl:latest
          command:
            - sh
            - -c
            - |
              until curl -sf http://redline.edc-v.svc.cluster.local:8081/api/public/health; do
                echo "Waiting for Redline to be ready..."
                sleep 5
              done
              echo "Redline is ready!"
      containers:
        - name: seed-redline
          image: curlimages/curl:latest
          env:
            - name: REDLINE_BASE_URL
              value: "http://redline.edc-v.svc.cluster.local:8081/api/ui"
          command:
            - sh
            - -c
            - |
              set -e

              echo "================================================"
              echo "Redline Seeding"
              echo "================================================"

              # Create Service Provider
              echo "Creating Service Provider..."
              SP_RESPONSE=$(curl -s -X POST "$REDLINE_BASE_URL/service-providers" \
                -H "Content-Type: application/json" \
                -d '{
                  "name": "JAD Service Provider"
                }')

              SP_ID=$(echo "$SP_RESPONSE" | grep -o '"id":"[^"]*"' | head -1 | cut -d'"' -f4)
              echo "Service Provider created with ID: $SP_ID"

              echo "Service Provider deployed successfully"
              echo "================================================"
              echo "Redline Seeding Complete"
              echo "================================================"

