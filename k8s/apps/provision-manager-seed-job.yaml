#
# Copyright (c) 2025 Metaform Systems, Inc.
#
# This program and the accompanying materials are made available under the
# terms of the Apache License, Version 2.0 which is available at
# https://www.apache.org/licenses/LICENSE-2.0
#
# SPDX-License-Identifier: Apache-2.0
#
# Contributors:
#      Metaform Systems, Inc. - initial API and implementation
#

apiVersion: batch/v1
kind: Job
metadata:
  name: provision-manager-seed
  namespace: edc-v
  labels:
    app: provision-manager-seed
    platform: edcv
    type: edcv-job
spec:
  backoffLimit: 5
  template:
    metadata:
      labels:
        app: provision-manager-seed
        platform: edcv
        type: edcv-job
    spec:
      restartPolicy: OnFailure
      initContainers:
        # Wait for provision-manager to be ready
        - name: wait-for-provision-manager
          image: curlimages/curl:latest
          command:
            - sh
            - -c
            - |
              until curl -sf http://provision-manager.edc-v.svc.cluster.local:8080/api/v1alpha1/activity-definitions; do
                echo "Waiting for provision-manager to be ready..."
                sleep 5
              done
              echo "Provision Manager is ready!"
      containers:
        - name: seed-provision-manager
          image: curlimages/curl:latest
          env:
            - name: PM_BASE_URL
              value: "http://provision-manager.edc-v.svc.cluster.local:8080"
          command:
            - sh
            - -c
            - |
              set -e

              echo "================================================"
              echo "ProvisionManager Seeding"
              echo "================================================"

              echo ""
              echo "Step 1: Create network-activity ActivityDefinition"
              echo "---------------------------------------------------"

              curl -sf -X POST "${PM_BASE_URL}/api/v1alpha1/activity-definitions" \
                -H "Content-Type: application/json" \
                -d '{ 
                  "description": "Provisions DNS entries",
                  "inputSchema": {},
                  "outputSchema": {},
                  "type": "network-activity"
                }'

              echo "✓ network-activity created"

              echo ""
              echo "Step 2: Create edcv-activity ActivityDefinition"
              echo "------------------------------------------------"

              curl -sf -X POST "${PM_BASE_URL}/api/v1alpha1/activity-definitions" \
                -H "Content-Type: application/json" \
                -d '{
                  "description": "Provisions EDC-V Control plane entries",
                  "inputSchema": {},
                  "outputSchema": {},
                  "type": "edcv-activity"
                }'

              echo "✓ edcv-activity created"

              echo ""
              echo "Step 3: Create registration-activity ActivityDefinition"
              echo "--------------------------------------------------------"

              curl -sf -X POST "${PM_BASE_URL}/api/v1alpha1/activity-definitions" \
                -H "Content-Type: application/json" \
                -d '{
                  "description": "Creates Holder entries on the IssuerService",
                  "inputSchema": {},
                  "outputSchema": {},
                  "type": "registration-activity"
                }'

              echo "✓ registration-activity created"

              echo ""
              echo "Step 4: Create keycloak-activity ActivityDefinition"
              echo "----------------------------------------------------"

              curl -sf -X POST "${PM_BASE_URL}/api/v1alpha1/activity-definitions" \
                -H "Content-Type: application/json" \
                -d '{
                  "description": "Provisions Keycloak clients",
                  "inputSchema": {},
                  "outputSchema": {},
                  "type": "keycloak-activity"
                }'

              echo "✓ keycloak-activity created"

              echo ""
              echo "Step 5: Create onboarding-activity ActivityDefinition"
              echo "------------------------------------------------------"

              curl -sf -X POST "${PM_BASE_URL}/api/v1alpha1/activity-definitions" \
                -H "Content-Type: application/json" \
                -d '{
                  "description": "Onboards participants (= requests credentials)",
                  "inputSchema": {},
                  "outputSchema": {},
                  "type": "onboarding-activity"
                }'

              echo "✓ onboarding-activity created"

              echo ""
              echo "Step 6: Create Orchestration Definition (deploy)"
              echo "------------------------------------------------"

              DEPLOY_ORCH_ID=$(cat /proc/sys/kernel/random/uuid)

              curl -sf -X POST "${PM_BASE_URL}/api/v1alpha1/orchestration-definitions" \
                -H "Content-Type: application/json" \
                -d '{
                  "activities": {
                    "cfm.orchestration.vpa.deploy": [{
                      "id": "kc-client-provisioner",
                      "type": "keycloak-activity",
                      "dependsOn": []
                    },
                    {
                      "id": "registration-agent",
                      "type": "registration-activity",
                      "dependsOn": [
                        "kc-client-provisioner"
                      ]
                    },
                    {
                      "id": "connector-provisioner",
                      "type": "edcv-activity",
                      "dependsOn": [
                        "kc-client-provisioner"
                      ]
                    },
                    {
                      "id": "onboarding-agent",
                      "type": "onboarding-activity",
                      "dependsOn": [
                        "connector-provisioner",
                        "registration-agent"
                      ]
                    }]
                  },
                  "description": "Orchestrates the deployment of a new dataspace member",
                  "schema": {},
                  "id": "'"${DEPLOY_ORCH_ID}"'"
                }'

              echo "✓ Deploy orchestration definition created (ID: ${DEPLOY_ORCH_ID})"
              
              
              echo ""
              echo "================================================"
              echo "ProvisionManager seeding completed!"
              echo "================================================"
